<%#
 Copyright 2010 Jo-Philipp Wich <jow@openwrt.org>
 Licensed to the public under the Apache License 2.0.

-%>

<%+header%>

<%
local fs   = require "nixio.fs"
local has_ping6 = fs.access("/bin/ping6") or fs.access("/usr/bin/ping6")
local has_traceroute6 = fs.access("/usr/bin/traceroute6")

local slk = luci.sys.exec("uci show luci.themes |grep slk")
local ne = "Seriallink"
if string.find(slk,"slk") then
	slk = "www.seriallink.net"

else
	slk = "8.8.8.8"
	ne = slk
end

%>

<script type="text/javascript" src="<%=resource%>/cbi.js"></script>
<script type="text/javascript">//<![CDATA[
	var stxhr = new XHR();

	function update_status(field, proto)
	{
		var tool = field.name;
		console.log(document.getElementById('id_selectport').value)
		var addr = document.getElementById('id_selectport').value+" "+field.value;
		var protocol = proto ? "6" : "";
		console.log(field,tool,addr,proto,protocol)
		var legend = document.getElementById('diag-rc-legend');
		var output = document.getElementById('diag-rc-output');

		if (legend && output)
		{
			output.innerHTML =
				'<img src="<%=resource%>/icons/loading.gif" alt="<%:Loading%>" style="vertical-align:middle" /> ' +
				'<%:Waiting for command to complete...%>'
			;

			legend.parentNode.style.display = 'block';
			legend.style.display = 'inline';
			var starr="";//(\ )(\')(\")(\,)
			var containSpecial = RegExp(/[(\~)(\~)(\!)(\£¡)(\@)(\#)(\$)(\£¤)(\%)(\^)(\¡­¡­)(\&)(\*)(\()(\£¨)(\))(\£©)(\-)(\_))(\¡ª¡ª)(\=)(\[)(\¡¾)(\])(\¡¿)(\{)(\})(\|))(\¡¢))(\)(\\)(\;)(\£»)(\:)(\£º)(\¡®)(\¡¯)(\¡°)(\¡±)(\£¬)(\.)(\¡£)(\/)(\¡¶)(\<)(\>)(\¡·)(\?)(\£¿)(\)]+/);
			if (containSpecial.test(addr)) {
			   for(var i=0;i<addr.length;i++){
                if(containSpecial.test(addr.charAt(i))){
				    starr +="&"+addr.charAt(i).charCodeAt()+"&"
                }else{
                    starr +=addr.charAt(i)
                }

			   }
			   console.log( starr)
			}else{
				starr=addr
			}
			stxhr.get('<%=luci.dispatcher.build_url("admin", "system")%>/diag_' + tool + protocol + '/' + starr+" ", null,
				function(x)
				{
					console.log(x.responseText)
					if (x.responseText)
					{
						legend.style.display = 'none';
						output.innerHTML = String.format('<pre>%h</pre>', x.responseText);
					}
					else
					{
						legend.style.display = 'none';
						output.innerHTML = '<span class="error"><%:Command specified!%></span>';
					}
				}
			);
		}
	}
	
	function update__status(field, proto)
	{
		var tool = field.name;
		console.log(document.getElementById('id_selectport').value)
		var addr = field.value;

		var protocol = proto ? "6" : "";
		console.log(field,tool,addr,proto,protocol)
		var legend = document.getElementById('diag-rc-legend');
		var output = document.getElementById('diag-rc-output');

		if (legend && output)
		{
			output.innerHTML =
				'<img src="<%=resource%>/icons/loading.gif" alt="<%:Loading%>" style="vertical-align:middle" /> ' +
				'<%:Waiting for command to complete...%>'
			;

			legend.parentNode.style.display = 'block';
			legend.style.display = 'inline';
			var starr="";//(\ )(\')(\")(\,)
			var containSpecial = RegExp(/[(\~)(\~)(\!)(\£¡)(\@)(\#)(\$)(\£¤)(\%)(\^)(\¡­¡­)(\&)(\*)(\()(\£¨)(\))(\£©)(\-)(\_))(\¡ª¡ª)(\=)(\[)(\¡¾)(\])(\¡¿)(\{)(\})(\|))(\¡¢))(\)(\\)(\;)(\£»)(\:)(\£º)(\¡®)(\¡¯)(\¡°)(\¡±)(\£¬)(\.)(\¡£)(\/)(\¡¶)(\<)(\>)(\¡·)(\?)(\£¿)(\)]+/);
			if (containSpecial.test(addr)) {
			   for(var i=0;i<addr.length;i++){
                if(containSpecial.test(addr.charAt(i))){
				    starr +="&"+addr.charAt(i).charCodeAt()+"&"
                }else{
                    starr +=addr.charAt(i)
                }

			   }
			   console.log( starr)
			}else{
				starr=addr
			}
			stxhr.get('<%=luci.dispatcher.build_url("admin", "system")%>/diag_dom' + protocol + '/' + starr+" ", null,
				function(x)
				{
					if (x.responseText)
					{
						legend.style.display = 'none';
						output.innerHTML = String.format('<pre>%h</pre>', x.responseText);
					}
					else
					{
						legend.style.display = 'none';
						output.innerHTML = '<span class="error"><%:Command specified!%></span>';
					}
				}
			);
		}
	}
//]]></script>
<style>
#divsty div{

display: inline;
margin:0 5px;
}
#atshow,
#protnone{
display:none  !important;
}
</style>
<form method="post" action="<%=pcdata(luci.http.getenv("REQUEST_URI"))%>">
	<div class="cbi-map">
		<h2><a id="content" name="content"><%:Linux Command%></a></h2>

		<fieldset class="cbi-section" id="divsty">
			<!-- <legend><%:Network Utilities%></legend> -->

			<br />

			<div style="width:80%; float:left">
			
			<select id="id_select" type="text" onChange="selectOnChangeFunc(this.value)">
				<option value="custom" class="cls_option_defined"><%:custom%></option>  
				<option value="sendat">sendat</option>
				<!-- <option value="ifconfig">ifconfig</option>   -->
			</select>  
			<div id="protnone">
				<a><%:Port%></a>
				<select id="id_selectport" type="text">  
					<option value="0">0</option>  
					<option value="1">1</option>  
					<option value="2">2</option>  
					<option value="3">3</option>				
					<option value="4">4</option>  
					<option value="5">5</option>  
					<option value="6">6</option>
				</select>    
			</div>
			<div id="atnone">
				<a id="textname"><%:Command%></a>
				<input style="width:25%;" type="text" id="id_input"  name="at"  value="">  
			</div>
			<input type="button" value="<%:AT%>" id="atshow" class="cbi-button cbi-button-apply" onclick="update_status(this.form.at)" />
			<input type="button" value="<%:Dom%>" id="domshow" class="cbi-button cbi-button-apply" onclick="update__status(this.form.at)" />
			<script>  
				function selectOnChangeFunc(then) {  
					if(then == "sendat"){
						document.getElementById("protnone").style="display:inline  !important;";
						document.getElementById("atshow").style="display:inline  !important;";
						document.getElementById("domshow").style="display:none  !important;";
						document.getElementById("id_input").value=""
						document.getElementById("textname").innerHTML="<%:AT Command%>"
					}else if(then == "custom"){
						document.getElementById("protnone").style="display:none  !important;"
						document.getElementById("atshow").style="display:none  !important;"
						document.getElementById("domshow").style="display:inline  !important;";
						document.getElementById("textname").innerHTML="<%:Command%>"
					}else{
						document.getElementById("protnone").style="display:none  !important;"
						document.getElementById("atshow").style="display:none  !important;"
						document.getElementById("domshow").style="display:inline  !important;";
						document.getElementById("textname").innerHTML="<%:Command%>"
						document.getElementById("id_input").value=document.getElementById("id_select").value
					}
					//document.getElementById('id_input').value = document.getElementById('id_select').options[document.getElementById('id_select').selectedIndex].value;  
				}  
			</script> 	
			
			</div>

			<br style="clear:both" /><br />
  
		</fieldset>
	</div>

	<fieldset class="cbi-section" style="display:none">
		<legend id="diag-rc-legend"><%:Collecting data...%></legend>
		<span id="diag-rc-output"></span>
	</fieldset>
</form>
 
<%+footer%>
